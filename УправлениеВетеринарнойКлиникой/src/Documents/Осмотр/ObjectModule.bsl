#Если Сервер Или ТолстыйКлиентОбычноеПриложение Или ВнешнееСоединение Тогда

#Область ОписаниеПеременных

#КонецОбласти

#Область ПрограммныйИнтерфейс

// Код процедур и функций

#КонецОбласти

#Область ОбработчикиСобытий

Процедура ОбработкаПроведения(Отказ,Режим)
	
	// регистр МедицинскиеКарты
	Движения.МедицинскиеКарты.Записывать = Истина;
	Движение = Движения.МедицинскиеКарты.Добавить();
	Движение.Питомец = Питомец;
	Движение.Дата = Дата;
	Движение.Врач = Врач;
	Движение.Диагноз = Диагноз;
	Движение.Жалобы = Жалобы;
	Движение.Рекомендации = Рекомендации;
	Движение.Осмотр = Ссылка;
	Движение.Назначения = СформироватьТекстНазначений();

КонецПроцедуры

Процедура ОбработкаЗаполнения(ДанныеЗаполнения,СтандартнаяОбработка)

	Если ТипЗнч(ДанныеЗаполнения) = Тип("ДокументСсылка.ЗаписьНаПрием") Тогда
		// Заполнение шапки
		ЗаписьНаПрием = ДанныеЗаполнения.Ссылка;
		Питомец = ДанныеЗаполнения.Питомец;
		Хозяин = ДанныеЗаполнения.Клиент;
		Врач = ДанныеЗаполнения.Врач;
		ДатаОсмотра = ДанныеЗаполнения.ДатаВремяНачала;

	КонецЕсли;

КонецПроцедуры

#КонецОбласти

#Область СлужебныйПрограммныйИнтерфейс

// Код процедур и функций

#КонецОбласти

#Область СлужебныеПроцедурыИФункции

Функция СформироватьТекстНазначений()
    
    ТекстНазначений = "";
    
    Для Каждого СтрокаТабличнойЧасти Из Назначения Цикл
        Если СтрокаТабличнойЧасти.Товар <> Неопределено Тогда
            // Формируем строку с информацией о назначении
            ТекстСтрокиНазначения = СтрокаТабличнойЧасти.Товар.Наименование + " - " +
                                   СтрокаТабличнойЧасти.Дозировка + ", " +
                                   СтрокаТабличнойЧасти.СпособПрименения + ", " +
                                   СтрокаТабличнойЧасти.Периодичность + ", " +
                                   СтрокаТабличнойЧасти.Продолжительность;
            
            // Добавляем примечание, если оно есть
            Если ЗначениеЗаполнено(СтрокаТабличнойЧасти.Примечание) Тогда
                ТекстСтрокиНазначения = ТекстСтрокиНазначения + " (" + СтрокаТабличнойЧасти.Примечание + ")";
            КонецЕсли;
            
            // Добавляем разделитель между назначениями
            ТекстНазначений = ТекстНазначений + ТекстСтрокиНазначения + Символы.ПС;
        КонецЕсли;
    КонецЦикла;
    
    // Убираем последний символ перевода строки, если он есть
    Если ТекстНазначений <> "" Тогда
        ТекстНазначений = Лев(ТекстНазначений, СтрДлина(ТекстНазначений) - 1);
    КонецЕсли;
    
    Возврат ТекстНазначений;
    
КонецФункции

#КонецОбласти

#Область Инициализация

#КонецОбласти

#КонецЕсли
